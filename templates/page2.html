<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>오늘의 운세 대시보드</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Serif KR', serif;
      background: #fdf7ff;
      margin: 0;
      padding: 16px;
      font-size: 17px;
    }

    .container {
      width: 100%;
      background: white;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h2 {
      font-size: 24px;
      text-align: center;
      color: #6a1b9a;
      margin-bottom: 16px;
    }

    h3 {
      font-size: 20px;
      color: #6a1b9a;
      margin-top: 24px;
    }

    p, label {
      font-size: 17px;
      line-height: 1.6;
      color: #444;
    }

    .section {
      margin-top: 24px;
    }

    input, select {
      width: 100%;
      font-size: 18px;
      padding: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-top: 6px;
    }

    button {
      width: 100%;
      padding: 16px;
      margin-top: 24px;
      background-color: #6a1b9a;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #4a148c;
    }

    .menu-list a {
      display: block;
      background: #6a1b9a;
      color: white;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      text-align: center;
    }

    .menu-list a:hover {
      background: #4a148c;
    }

    .tip, .section > div, .spinner {
      font-size: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 5px solid #e0b3ff;
      border-top: 5px solid #6a1b9a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes popFade {
      0%   { transform: translateX(-50%) scale(0.8); opacity: 0; }
      20%  { transform: translateX(-50%) scale(1.1); opacity: 1; }
      60%  { transform: translateX(-50%) scale(1); }
      100% { transform: translateX(-50%) scale(1); opacity: 0; }
    }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CHYCMGWE1Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CHYCMGWE1Y');
  </script>
</head>
<body>
  <div id="loadingInitial" style="text-align:center; padding: 60px;">
    <div class="spinner"></div>
    <p style="margin-top: 14px; font-size: 18px; color: #6a1b9a;">사주를 정성껏 정리 중입니다...</p>
  </div>
  <div id="welcomeBanner" style="
    display:none;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffeb3b;
    padding: 20px 30px;
    border-radius: 16px;
    font-weight: bold;
    font-size: 18px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 9999;
    animation: popFade 4s ease forwards;
  ">
✨ {{ name }}님의 사주풀이가 완성!!  💫
</div>
  <div id="realContent" style="display:none;">
  <div class="container">
    <h2>🔮 {{ name }}님의 사주팔자</h2>

    <div class="section">
      <h3>🧠 분석 결과</h3>
      <p>{{ saju_analyzer_result|safe }}</p>

      <h3>🌿 사주 상세 정보</h3>
      <table style="width:100%; border-collapse: collapse; margin-top: 12px; font-size: 16px;">
        <thead>
          <tr style="background-color: #f3e5f5; color: #4a148c;">
            <th style="padding: 10px; border: 1px solid #ccc;">항목</th>
            <th style="padding: 10px; border: 1px solid #ccc;">년柱</th>
            <th style="padding: 10px; border: 1px solid #ccc;">월柱</th>
            <th style="padding: 10px; border: 1px solid #ccc;">일柱</th>
            <th style="padding: 10px; border: 1px solid #ccc;">시柱</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">천간</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.gan }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.gan }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.gan }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.gan }}</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">지지</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.zhi }}</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">오행</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.element_gan }}/{{ saju_info.year.element_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.element_gan }}/{{ saju_info.month.element_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.element_gan }}/{{ saju_info.day.element_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.element_gan }}/{{ saju_info.hour.element_zhi }}</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">음양</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.yin_gan }}/{{ saju_info.year.yin_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.yin_gan }}/{{ saju_info.month.yin_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.yin_gan }}/{{ saju_info.day.yin_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.yin_gan }}/{{ saju_info.hour.yin_zhi }}</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">십성</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.ten_god }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.ten_god }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.ten_god }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.ten_god }}</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">지지의 십성</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.ten_god_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.ten_god_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.ten_god_zhi }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.ten_god_zhi }}</td>
          </tr>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">십이운성</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.twelve_stage }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.twelve_stage }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.twelve_stage }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.twelve_stage }}</td>
          </tr>
          <!-- <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">십이신살</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.year.twelve_god }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.month.twelve_god }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.day.twelve_god }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ saju_info.hour.twelve_god }}</td>
          </tr> -->
        </tbody>
      </table>
      {% if ctext_explanation %}
      <div style="margin-top: 20px; background: #f3f3ff; border-left: 5px solid #11a09b; padding: 15px; border-radius: 8px;">
        <strong>📜 삼명통회 원문</strong><br><br>
          <div style="white-space: pre-wrap;">{{ ctext_explanation|safe }}</div>
        </div>
      {% endif %}

      {% if ctext_kr_literal %}
        <div style="margin-top: 20px; background: #fff8e1; border-left: 5px solid #ff6f00; padding: 15px; border-radius: 8px;">
          <strong>📚 삼명통회 해석</strong><br><br>
          <div style="white-space: pre-wrap;">{{ ctext_kr_literal|safe }}</div>
        </div>
      {% endif %}

      
      
      {% if ilju_interpretation and ilju_interpretation.kr %}
        <div style="margin-top: 20px; background: #f3f3ff; border-left: 5px solid #7986cb; padding: 15px; border-radius: 8px;">
          <strong>📜 일주 해석 ({{ ilju | safe }}):</strong><br><br>
          {{ ilju_interpretation.kr | safe }}
        </div>
      {% endif %}


      <h3>✨ AI 사주 해석</h3>
      <button onclick="loadSajuAnalysis()">AI 사주 해석 보기</button>

      <div id="pdfLoadingSpinner" style="display:none; text-align:center; margin-top:20px;">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:#6a1b9a;">당신만을 위한 리포트를 생성 중입니다...</p>
      </div>
      <div id="aiAnalysisBox" style="display:none; margin-top:20px; background:#f3f3ff; padding:15px; border-left:5px solid #6a1b9a; border-radius:8px;"></div>

    </div>

    <div class="section">
      <div id="paymentSection" style="display:none; text-align: center;">
        <button onclick="gtag('event', 'click_donate', {
    event_category: 'engagement',
    event_label: '후원버튼',
    value: 1
  }); console.log('✅ click_donate event sent to GA4'); document.getElementById('donationModal').style.display='block';" style="width: 100%; padding: 16px; margin-top: 24px; background-color: #11a09b; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer;">
          ☕ 커피 한 잔으로 응원하기
        </button>
      </div>

      <div id="donationModal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; overflow-y: auto;">
        <div style="background: white; max-width: 500px; margin: 100px auto; padding: 30px; border-radius: 16px; position: relative; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);">
          <button onclick="document.getElementById('donationModal').style.display='none';" style="position: absolute; top: 12px; right: 12px; background: #e0e0e0; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 20px; font-weight: bold; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">×</button>
          <h3 style="color: #6a1b9a; font-size: 20px; margin-bottom: 20px; text-align: center;">소중한 후원에 미리 감사드립니다 🙏</h3>
          <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
            <div>
              <p style="font-weight: bold; text-align: center;">카카오 송금</p>
              <img src="/static/assets/qr_kakao.jpg" alt="카카오페이 QR" style="width: 180px; display: block; margin: 0 auto; border: 1px solid #ccc; border-radius: 8px;" />
            </div>
            <div>
              <p style="font-weight: bold; text-align: center;">토스 송금</p>
              <img src="/static/assets/qr_toss.jpg" alt="토스페이 QR" style="width: 180px; display: block; margin: 0 auto; border: 1px solid #ccc; border-radius: 8px;" />
            </div>
          </div>
        </div>
      </div>

      <div id="loadingSpinner" style="display:none; margin-top: 30px; text-align: center;">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: #6a1b9a;">결과를 받아오는 중입니다...</p>
      </div>
    </div>

    <div id="fortuneModal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; overflow-y: auto;">
      <div style="background: white; max-width: 700px; margin: 100px auto; padding: 40px; border-radius: 16px; position: relative; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); max-height: 90vh; overflow-y: auto;">
        <button onclick="closeModal()" style="position: absolute; top: 10px; right: 10px; background: #e0e0e0; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; font-weight: bold; color: #555; cursor: pointer;">×</button>
        <h3 id="modalTitle" style="color: #6a1b9a; font-size: 22px; text-align: center; margin-bottom: 20px;"></h3>
        <div id="modalContent" style="margin-top: 20px; line-height: 1.8; color: #333; font-size: 15px; text-align: left;"></div>
      </div>
    </div>


  </div>
  </div>
  <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.7); z-index: 1000;">
    <div class="spinner" style="margin-top: 40vh;"></div>
  </div>
  <script>
    const cachedFortunes = {};  // 메뉴별 캐시 저장

    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function loadFortune(menu) {
      if (cachedFortunes[menu] && cachedFortunes[menu].fortune_result) {
        showFortuneModal(cachedFortunes[menu]);
        return;
      }

      showLoading();

      fetch('/api/fortune/' + menu)
        .then(res => res.json())
        .then(data => {
          cachedFortunes[menu] = data;
          showFortuneModal(data);
          hideLoading();
        })
        .catch(err => {
          alert("오류가 발생했습니다: " + err);
          hideLoading();
        });
    }

    function showFortuneModal(data) {
    console.log("💬 모달에 전달된 데이터", data);

    if (!data || !data.fortune_result) {
      alert("운세 데이터를 불러오지 못했습니다.");
      return;
    }

    const title = data.menu_title || '운세 결과';
    const content = data.fortune_result || '결과를 불러오는 데 문제가 발생했습니다.';

    document.getElementById('modalTitle').innerText = title;
    let coffeeMsg = `
      <div style="text-align: center; margin-top: 40px;">
        <p style="font-size: 15px; color: #555;">
          이 운세가 도움이 되셨나요? <br>
          따뜻한 커피 한 잔으로 이 서비스를 응원해 주세요 ☕
          <br><a href="{{ coffee_link }}" target="_blank"
             style="color: #d81b60; font-weight: bold; text-decoration: none;">
            👉 따뜻한 커피 한 잔으로 응원하기
          </a>
        </p>
      </div>`;
    document.getElementById('modalContent').innerHTML = content + coffeeMsg;
      document.getElementById('fortuneModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('fortuneModal').style.display = 'none';
    }

    function openMatchModal() {
      document.getElementById('matchModal').style.display = 'block';
    }

    function closeMatchModal() {
      document.getElementById('matchModal').style.display = 'none';
    }
  </script>
  <script>
    function loadSajuAnalysis() {
      const box = document.getElementById("aiAnalysisBox");
      box.innerHTML = '<div class="spinner" style="margin:20px auto;"></div><p style="text-align:center; color:#6a1b9a;">AI 해석 중입니다...</p>';
      box.style.display = 'block';

      fetch('/api/saju_ai_analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      }).then(res => res.json())
        .then(data => {
          if (data.result) {
            box.innerHTML = '<strong>🔍 AI 해석 결과:</strong><br><br>' + data.result;
          } else {
            box.innerHTML = '<p style="color:red;">AI 해석에 실패했습니다.</p>';
          }
          document.getElementById('paymentSection').style.display = 'block';
        })
        .catch(err => {
          box.innerHTML = '<p style="color:red;">서버 통신 오류가 발생했습니다.</p>';
        });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    window.onload = function () {
      setTimeout(() => {
        document.getElementById('loadingInitial').style.display = 'none';
        document.getElementById('realContent').style.display = 'block';

        // 2.2초 후에 팡 터지는 효과
        confetti({
          particleCount: 120,
          spread: 90,
          origin: { y: 0.6 },
        });

        // welcomeBanner도 동시에 표시
        const banner = document.getElementById('welcomeBanner');
        banner.style.display = 'block';
        setTimeout(() => {
          banner.style.display = 'none';
        }, 4000);
      }, 3000);
    };
  </script>
</body>

  <script>
  const generateBtn = document.getElementById('generatePdfButton');
  if (generateBtn) {
    generateBtn.addEventListener('click', function() {
      const currentYear = new Date().getFullYear();
      const nextYear = currentYear + 1;
      document.getElementById('pdfLoadingSpinner').style.display = 'block';

      setTimeout(() => {
        document.getElementById('pdfLoadingSpinner').style.display = 'none';
        document.getElementById('pdfPreviewModal').style.display = 'block';
      }, 2500);
    });
  }

  function closePdfPreview() {
    document.getElementById('pdfPreviewModal').style.display = 'none';
  }
  </script>
</html>